# ğŸ¯ Akiku ä»¿çœŸæ¡†æ¶å¼€å‘ä»»åŠ¡ä¹¦

## é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**: Akiku Simulation Framework  
**è¯­è¨€**: Rust  
**ç›®æ ‡**: æ„å»ºä¸€ä¸ªé€šç”¨ã€é«˜æ€§èƒ½çš„å›¾é©±åŠ¨ä»¿çœŸå¼•æ“

---

## å¼€å‘é˜¶æ®µåˆ’åˆ†

### Phase 1: æ ¸å¿ƒæ•°æ®ç»“æ„ä¸åŸºç¡€ç±»å‹ âœ¦ åŸºç¡€å±‚
> **ç›®æ ‡**: å®šä¹‰æ‰€æœ‰æ ¸å¿ƒç±»å‹ï¼Œå»ºç«‹é¡¹ç›®éª¨æ¶

| Task | æè¿° | äº§å‡º |
|------|------|------|
| 1.1 | åˆå§‹åŒ– Rust é¡¹ç›®ï¼Œé…ç½® Cargo workspace | `Cargo.toml`, é¡¹ç›®ç»“æ„ |
| 1.2 | å®šä¹‰åŸºç¡€ç±»å‹ (`SimTime`, `NodeId`, `SubgraphId`) | `src/types.rs` |
| 1.3 | å®šä¹‰èŠ‚ç‚¹ç›¸å…³ç»“æ„ (`NodeKind`, `NodePort`, `NodeDesc`) | `src/node.rs` |
| 1.4 | å®šä¹‰äº‹ä»¶ç»“æ„ (`Event`, `EventPayload`) | `src/event.rs` |
| 1.5 | å®šä¹‰é€šé“ç»“æ„ (`ChannelDesc`, `TimeAlignment`) | `src/channel.rs` |
| 1.6 | å®šä¹‰å­å›¾ç»“æ„ (`TimeMode`, `SubgraphDesc`) | `src/subgraph.rs` |

**éªŒæ”¶æ ‡å‡†**: `cargo build` é€šè¿‡ï¼Œæ‰€æœ‰ç±»å‹å¯æ­£å¸¸å®ä¾‹åŒ–

---

### Phase 2: Trait æ¥å£å®šä¹‰ âœ¦ æŠ½è±¡å±‚
> **ç›®æ ‡**: å®šä¹‰ Node å’Œ SubgraphExecutor çš„ trait æ¥å£

| Task | æè¿° | äº§å‡º |
|------|------|------|
| 2.1 | å®šä¹‰ `Node` traitï¼ˆ`init`, `on_tick`, `on_event`ï¼‰ | `src/node.rs` |
| 2.2 | å®šä¹‰ `SubgraphExecutor` trait | `src/executor.rs` |
| 2.3 | ç¼–å†™ç®€å•çš„ Mock èŠ‚ç‚¹å®ç°ç”¨äºæµ‹è¯• | `src/nodes/mock.rs` |

**éªŒæ”¶æ ‡å‡†**: Trait å®šä¹‰å®Œæ•´ï¼ŒMock å®ç°å¯ç¼–è¯‘

---

### Phase 3: Tick-Driven å­å›¾æ‰§è¡Œå™¨ âœ¦ æ‰§è¡Œå±‚
> **ç›®æ ‡**: å®ç°å‘¨æœŸé©±åŠ¨çš„å­å›¾æ‰§è¡Œå™¨

| Task | æè¿° | äº§å‡º |
|------|------|------|
| 3.1 | å®ç° `TickSubgraphExecutor` åŸºæœ¬ç»“æ„ | `src/executor/tick.rs` |
| 3.2 | å®ç°èŠ‚ç‚¹æ‹“æ‰‘æ’åºç®—æ³• | åŒä¸Š |
| 3.3 | å®ç° `run_until()` çš„ tick å¾ªç¯é€»è¾‘ | åŒä¸Š |
| 3.4 | å®ç° `handle_incoming()` äº‹ä»¶æ¥æ”¶ | åŒä¸Š |
| 3.5 | å•å…ƒæµ‹è¯•ï¼šå•èŠ‚ç‚¹ tick æ¨è¿› | `tests/tick_executor.rs` |
| 3.6 | å•å…ƒæµ‹è¯•ï¼šå¤šèŠ‚ç‚¹ä¾èµ–é“¾ tick æ¨è¿› | åŒä¸Š |

**éªŒæ”¶æ ‡å‡†**: Tick å­å›¾å¯ç‹¬ç«‹è¿è¡Œï¼ŒèŠ‚ç‚¹æŒ‰æ‹“æ‰‘åºæ‰§è¡Œ

---

### Phase 4: Event-Driven å­å›¾æ‰§è¡Œå™¨ âœ¦ æ‰§è¡Œå±‚
> **ç›®æ ‡**: å®ç°äº‹ä»¶é©±åŠ¨çš„å­å›¾æ‰§è¡Œå™¨

| Task | æè¿° | äº§å‡º |
|------|------|------|
| 4.1 | å®ç°äº‹ä»¶ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆåŸºäº `BTreeMap`ï¼‰ | `src/executor/event.rs` |
| 4.2 | å®ç° `EventSubgraphExecutor` åŸºæœ¬ç»“æ„ | åŒä¸Š |
| 4.3 | å®ç° `run_until()` çš„äº‹ä»¶å¤„ç†å¾ªç¯ | åŒä¸Š |
| 4.4 | å®ç° `handle_incoming()` äº‹ä»¶æ’å…¥ | åŒä¸Š |
| 4.5 | å•å…ƒæµ‹è¯•ï¼šäº‹ä»¶äº§ç”Ÿä¸æ¶ˆè´¹ | `tests/event_executor.rs` |
| 4.6 | å•å…ƒæµ‹è¯•ï¼šäº‹ä»¶é“¾å¼è§¦å‘ | åŒä¸Š |

**éªŒæ”¶æ ‡å‡†**: Event å­å›¾å¯ç‹¬ç«‹è¿è¡Œï¼Œäº‹ä»¶æŒ‰æ—¶é—´é¡ºåºå¤„ç†

---

### Phase 5: æ—¶é—´å¯¹é½ä¸é€šé“é€»è¾‘ âœ¦ é€šä¿¡å±‚
> **ç›®æ ‡**: å®ç°è·¨å­å›¾é€šä¿¡å’Œæ—¶é—´å¯¹é½

| Task | æè¿° | äº§å‡º |
|------|------|------|
| 5.1 | å®ç° `CeilToTick` å¯¹é½ç®—æ³• | `src/channel.rs` |
| 5.2 | å®ç° `FloorToTick` å¯¹é½ç®—æ³• | åŒä¸Š |
| 5.3 | å®ç° `StrictTickBoundary` å¯¹é½ç®—æ³• | åŒä¸Š |
| 5.4 | å®ç°é€šé“å»¶è¿Ÿè®¡ç®—é€»è¾‘ | åŒä¸Š |
| 5.5 | å•å…ƒæµ‹è¯•ï¼šå„ç§å¯¹é½è§„åˆ™çš„æ­£ç¡®æ€§ | `tests/alignment.rs` |

**éªŒæ”¶æ ‡å‡†**: Eventâ†’Tick æ¶ˆæ¯èƒ½æ­£ç¡®å¯¹é½åˆ°ç›®æ ‡ tick è¾¹ç•Œ

---

### Phase 6: å…¨å±€åè°ƒå™¨ SimulationEngine âœ¦ è°ƒåº¦å±‚
> **ç›®æ ‡**: å®ç°å…¨å±€ä»¿çœŸå¼•æ“

| Task | æè¿° | äº§å‡º |
|------|------|------|
| 6.1 | å®ç° `SimulationEngine` åŸºæœ¬ç»“æ„ | `src/engine.rs` |
| 6.2 | å®ç°å­å›¾æ³¨å†Œä¸åˆå§‹åŒ– | åŒä¸Š |
| 6.3 | å®ç° `dispatch_to_subgraphs()` äº‹ä»¶åˆ†å‘ | åŒä¸Š |
| 6.4 | å®ç° `process_outgoing()` äº‹ä»¶æ”¶é›†ä¸å¤„ç† | åŒä¸Š |
| 6.5 | å®ç° `run()` ä¸»å¾ªç¯ | åŒä¸Š |
| 6.6 | é›†æˆæµ‹è¯•ï¼šçº¯ Tick å­å›¾ä»¿çœŸ | `tests/integration.rs` |
| 6.7 | é›†æˆæµ‹è¯•ï¼šçº¯ Event å­å›¾ä»¿çœŸ | åŒä¸Š |
| 6.8 | é›†æˆæµ‹è¯•ï¼šTick + Event æ··åˆä»¿çœŸ | åŒä¸Š |

**éªŒæ”¶æ ‡å‡†**: å¤šå­å›¾ååŒè¿è¡Œï¼Œè·¨å­å›¾æ¶ˆæ¯æ­£ç¡®ä¼ é€’

---

### Phase 7: é…ç½®ç³»ç»Ÿ âœ¦ é…ç½®å±‚
> **ç›®æ ‡**: æ”¯æŒ YAML/JSON é…ç½®æ–‡ä»¶é©±åŠ¨

| Task | æè¿° | äº§å‡º |
|------|------|------|
| 7.1 | æ·»åŠ  `serde`, `serde_yaml` ä¾èµ– | `Cargo.toml` |
| 7.2 | ä¸ºæ‰€æœ‰ Desc ç»“æ„å®ç° Serialize/Deserialize | å„æ¨¡å— |
| 7.3 | å®šä¹‰é…ç½®æ–‡ä»¶ schema (`SimConfig`) | `src/config.rs` |
| 7.4 | å®ç°é…ç½®åŠ è½½ä¸éªŒè¯ | åŒä¸Š |
| 7.5 | å®ç°èŠ‚ç‚¹å·¥å‚æ³¨å†Œè¡¨ | `src/registry.rs` |
| 7.6 | ç¼–å†™ç¤ºä¾‹é…ç½®æ–‡ä»¶ | `examples/config.yaml` |

**éªŒæ”¶æ ‡å‡†**: å¯é€šè¿‡é…ç½®æ–‡ä»¶å¯åŠ¨å®Œæ•´ä»¿çœŸ

---

### Phase 8: ç»Ÿè®¡ä¸è¾“å‡º âœ¦ å¯è§‚æµ‹å±‚
> **ç›®æ ‡**: å®ç°ç»Ÿè®¡æ”¶é›†ä¸å¯¼å‡º

| Task | æè¿° | äº§å‡º |
|------|------|------|
| 8.1 | å®šä¹‰ç»Ÿè®¡æ•°æ®ç»“æ„ (`Stats`) | `src/stats.rs` |
| 8.2 | åœ¨å„ Executor ä¸­å®ç° `export_stats()` | å„æ‰§è¡Œå™¨ |
| 8.3 | å®ç° Engine çº§ç»Ÿè®¡èšåˆ | `src/engine.rs` |
| 8.4 | å®ç° JSON/CSV å¯¼å‡º | `src/stats.rs` |
| 8.5 | æ·»åŠ åŸºæœ¬æ—¥å¿—è¾“å‡ºï¼ˆ`tracing` crateï¼‰ | å…¨å±€ |

**éªŒæ”¶æ ‡å‡†**: ä»¿çœŸç»“æŸåè¾“å‡ºå®Œæ•´ç»Ÿè®¡æŠ¥å‘Š

---

### Phase 9: ç¤ºä¾‹èŠ‚ç‚¹å®ç° âœ¦ åº”ç”¨å±‚
> **ç›®æ ‡**: æä¾›å‡ ä¸ªå…¸å‹èŠ‚ç‚¹å®ç°ä½œä¸ºå‚è€ƒ

| Task | æè¿° | äº§å‡º |
|------|------|------|
| 9.1 | å®ç° `PassThroughNode`ï¼ˆé€ä¼ èŠ‚ç‚¹ï¼‰ | `src/nodes/passthrough.rs` |
| 9.2 | å®ç° `DelayNode`ï¼ˆå›ºå®šå»¶è¿ŸèŠ‚ç‚¹ï¼‰ | `src/nodes/delay.rs` |
| 9.3 | å®ç° `ProbabilisticDelayNode`ï¼ˆæ¦‚ç‡å»¶è¿Ÿï¼‰ | `src/nodes/probabilistic.rs` |
| 9.4 | å®ç°ç®€å• `PipelineStageNode`ï¼ˆæµæ°´çº§ï¼‰ | `src/nodes/pipeline.rs` |
| 9.5 | ç¼–å†™ç«¯åˆ°ç«¯ç¤ºä¾‹ï¼ˆmini cache ä»¿çœŸï¼‰ | `examples/mini_cache.rs` |

**éªŒæ”¶æ ‡å‡†**: ç¤ºä¾‹å¯è¿è¡Œï¼Œè¾“å‡ºç¬¦åˆé¢„æœŸ

---

### Phase 10: å¹¶è¡ŒåŒ–ä¼˜åŒ– âœ¦ æ€§èƒ½å±‚ (å¯é€‰è¿›é˜¶)
> **ç›®æ ‡**: æ”¯æŒå¤šçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œå­å›¾

| Task | æè¿° | äº§å‡º |
|------|------|------|
| 10.1 | å¼•å…¥ `rayon` æˆ– `tokio` å¹¶è¡Œæ¡†æ¶ | `Cargo.toml` |
| 10.2 | å®ç°å­å›¾å¹¶è¡Œè°ƒåº¦ | `src/engine.rs` |
| 10.3 | å®ç°çº¿ç¨‹å®‰å…¨çš„äº‹ä»¶é˜Ÿåˆ— | `src/channel.rs` |
| 10.4 | æ€§èƒ½åŸºå‡†æµ‹è¯• | `benches/` |

---

## å»ºè®®çš„é¡¹ç›®ç»“æ„

```
akiku/
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs
â”‚   â”œâ”€â”€ types.rs          # SimTime, NodeId, SubgraphId
â”‚   â”œâ”€â”€ event.rs          # Event, EventPayload
â”‚   â”œâ”€â”€ node.rs           # Node trait, NodeDesc, NodeKind
â”‚   â”œâ”€â”€ channel.rs        # ChannelDesc, TimeAlignment
â”‚   â”œâ”€â”€ subgraph.rs       # SubgraphDesc, TimeMode
â”‚   â”œâ”€â”€ executor/
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ tick.rs       # TickSubgraphExecutor
â”‚   â”‚   â””â”€â”€ event.rs      # EventSubgraphExecutor
â”‚   â”œâ”€â”€ engine.rs         # SimulationEngine
â”‚   â”œâ”€â”€ config.rs         # é…ç½®åŠ è½½
â”‚   â”œâ”€â”€ registry.rs       # èŠ‚ç‚¹æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ stats.rs          # ç»Ÿè®¡
â”‚   â””â”€â”€ nodes/            # å†…ç½®èŠ‚ç‚¹å®ç°
â”‚       â”œâ”€â”€ mod.rs
â”‚       â”œâ”€â”€ mock.rs
â”‚       â”œâ”€â”€ passthrough.rs
â”‚       â”œâ”€â”€ delay.rs
â”‚       â””â”€â”€ ...
â”œâ”€â”€ tests/                # é›†æˆæµ‹è¯•
â”œâ”€â”€ examples/             # ç¤ºä¾‹
â””â”€â”€ spec/                 # è§„æ ¼æ–‡æ¡£
```

---

## å¼€å‘ä¼˜å…ˆçº§å»ºè®®

```
é«˜ä¼˜å…ˆçº§ï¼ˆMVPï¼‰: Phase 1 â†’ 2 â†’ 3 â†’ 4 â†’ 6
ä¸­ä¼˜å…ˆçº§ï¼ˆå®Œæ•´åŠŸèƒ½ï¼‰: Phase 5 â†’ 7 â†’ 8
ä½ä¼˜å…ˆçº§ï¼ˆå¢å¼ºï¼‰: Phase 9 â†’ 10
```

